<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pool League - This Week</title>
  <link rel="stylesheet" href="/styles/header.css">
  <link rel="stylesheet" href="/styles/poolLeague.css">
</head>
<body>
  <h2>
    <%- include('templates/header.ejs'); %>
  </h2>

  <h1>Pool League - <%= seasonLabel %></h1>

  <div class="pool-tabs">
    <a href="/poolLeague/this-week" class="pool-tab active">This Week</a>
    <a href="/poolLeague/history" class="pool-tab">Match History</a>
    <a href="/poolLeague/standings" class="pool-tab">Standings</a>
  </div>

  <% if (success) { %>
    <p class="flash success"><%= success %></p>
  <% } %>

  <% if (error) { %>
    <p class="flash error"><%= error %></p>
  <% } %>

  <% if (teams.length === 0) { %>
    <p class="empty-state">No teams are registered yet. Add teams to teams.csv (see teams-sample.csv) and restart.</p>
  <% } else { %>
    <form method="GET" action="/poolLeague/this-week" class="controls">
      <label for="teamId">Select your team:</label>
      <select id="teamId" name="teamId" class="dropdown" onchange="this.form.submit()">
        <option value="" <%= !activeTeamId ? 'selected' : '' %>>All Matches</option>
        <% teams.forEach(team => { %>
          <option value="<%= team._id %>" <%= String(team._id) === String(activeTeamId) ? 'selected' : '' %>><%= team.name %></option>
        <% }); %>
      </select>
    </form>

    <% if (!isPlayoffsView) { %>
      <h3>Week <%= currentWeek %> (Regular Season)</h3>
      <% if (isBreakWeek) { %>
        <p class="flash info">This week is a scheduled break â€” no matches. See you next week!</p>
      <% } %>
    <% } else { %>
      <h3>Playoff Matches</h3>
    <% } %>

    <% if (matches.length === 0) { %>
      <p class="empty-state">No matches available for this view yet.</p>
    <% } %>

    <% matches.forEach(match => { %>
      <div class="match-card">
        <div class="match-top">
          <% if (activeTeamId) { %>
            <p><strong>Opponent:</strong> <%= match.opponent %></p>
          <% } else { %>
            <p><strong>Matchup:</strong> <%= match.matchup %></p>
          <% } %>
          <p><strong>Status:</strong> <%= match.statusLabel %></p>
          <% if (match.phase === 'PLAYOFFS') { %>
            <p><strong>Series:</strong> <%= match.playoffRound %> - Best of <%= match.bestOf %></p>
            <% if (match.statusLabel === 'Complete') { %>
              <p><strong>Series Result:</strong> <%= match.teamAName %> <%= match.teamAScore %> - <%= match.teamBScore %> <%= match.teamBName %></p>
            <% } %>
          <% } %>
        </div>

        <div class="match-meta">
          <p><strong>Time:</strong> <%= match.scheduledAt ? new Date(match.scheduledAt).toLocaleString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'TBD' %></p>
        </div>

        <% if (match.statusLabel !== 'Complete') { %>
          <form method="POST" action="/poolLeague/match/<%= match.id %>/score" class="inline-form">
            <input type="hidden" name="teamId" value="<%= activeTeamId %>">
            <% if (match.phase === 'PLAYOFFS') { %>
              <fieldset>
                <legend>Enter Series Result</legend>
                <select name="winner" class="dropdown" required>
                  <option value="">Select Winner</option>
                  <option value="<%= match.teamAName %>"><%= match.teamAName %></option>
                  <option value="<%= match.teamBName %>"><%= match.teamBName %></option>
                </select>
                <div class="score-inputs">
                  <label>
                    <%= match.teamAName %> Wins:
                    <input type="number" name="teamAScore" min="0" class="score-input" required>
                  </label>
                  <label>
                    <%= match.teamBName %> Wins:
                    <input type="number" name="teamBScore" min="0" class="score-input" required>
                  </label>
                </div>
                <button type="submit" class="small-button">Submit Series Result</button>
              </fieldset>
            <% } else { %>
              <select name="winner" class="dropdown" required>
                <option value="">Select Winner</option>
                <option value="<%= match.teamAName %>"><%= match.teamAName %></option>
                <option value="<%= match.teamBName %>"><%= match.teamBName %></option>
              </select>
              <button type="submit" class="small-button">Submit Winner</button>
            <% } %>
          </form>
        <% } else { %>
          <% if (match.winnerTeamId && match.winnerTeamId === String(match.teamAId)) { %>
            <p class="final-score"><strong><%= match.phase === 'PLAYOFFS' ? 'Series Winner' : 'Winner' %>:</strong> <%= match.teamAName %></p>
          <% } else if (match.winnerTeamId && match.winnerTeamId === String(match.teamBId)) { %>
            <p class="final-score"><strong><%= match.phase === 'PLAYOFFS' ? 'Series Winner' : 'Winner' %>:</strong> <%= match.teamBName %></p>
          <% } %>
          <% if (match.phase === 'PLAYOFFS') { %>
            <form method="POST" action="/poolLeague/match/<%= match.id %>/score" class="inline-form">
              <input type="hidden" name="teamId" value="<%= activeTeamId %>">
              <fieldset>
                <legend>Change Series Result</legend>
                <select name="winner" class="dropdown" required>
                  <option value="">Select Winner</option>
                  <option value="<%= match.teamAName %>"><%= match.teamAName %></option>
                  <option value="<%= match.teamBName %>"><%= match.teamBName %></option>
                </select>
                <div class="score-inputs">
                  <label>
                    <%= match.teamAName %> Wins:
                    <input type="number" name="teamAScore" min="0" class="score-input" required>
                  </label>
                  <label>
                    <%= match.teamBName %> Wins:
                    <input type="number" name="teamBScore" min="0" class="score-input" required>
                  </label>
                </div>
                <button type="submit" class="small-button">Change Result</button>
              </fieldset>
            </form>
          <% } else { %>
            <form method="POST" action="/poolLeague/match/<%= match.id %>/score" class="inline-form">
              <input type="hidden" name="teamId" value="<%= activeTeamId %>">
              <select name="winner" class="dropdown" required>
                <option value="">Change Winner</option>
                <option value="<%= match.teamAName %>"><%= match.teamAName %></option>
                <option value="<%= match.teamBName %>"><%= match.teamBName %></option>
              </select>
              <button type="submit" class="small-button">Update Winner</button>
            </form>
          <% } %>
        <% } %>
      </div>
    <% }); %>
  <% } %>

  <% if (season.status === 'SIGNUP') { %>
    <form method="POST" action="/poolLeague/generate-schedule" class="admin-control">
      <button type="submit" class="submit-button">Generate <%= season.regularWeeks %>-Week Regular Season Schedule</button>
    </form>
  <% } %>

<%# TESTING BUTTONS - commented out for main build %>
<% if (false) { %>
  <% if (season.status === 'REGULAR') { %>
    <form method="POST" action="/poolLeague/fill-random-results" class="admin-control">
      <button type="submit" class="submit-button">Fill Random Match Results (Testing)</button>
    </form>
    <form method="POST" action="/poolLeague/force-start-playoffs" class="admin-control">
      <button type="submit" class="submit-button">Force Start Playoffs (Testing)</button>
    </form>
  <% } %>
<% } %>
</body>
</html>
